{% extends "sudoku/base.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Leaderboard</h2>

  <div class="text-center mb-4">
    <p>
      For a detailed explanation of how the rating is computed,
      <a href="#" data-bs-toggle="modal" data-bs-target="#formulaModal">click here</a>.
    </p>
  </div>

  <!-- Leaderboard Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
      <tr>
        <th>Rank</th>
        <th>User</th>
        <th>Total Score</th>
        <th>Puzzles Solved</th>
      </tr>
      </thead>
      <tbody>
      {% for entry in leaderboard %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ entry.user }}</td>
        <td>{{ entry.score }}</td>
        <td>{{ entry.solved }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <!-- Modal explaining the new Sudoku Power Index (SPI) formula -->
  <div class="modal fade" id="formulaModal" tabindex="-1" aria-labelledby="formulaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="formulaModalLabel">How Is Your Rating Calculated?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body px-4 py-3">

          <p>
            The leaderboard uses the <strong>Sudoku&nbsp;Power&nbsp;Index (SPI)</strong> &mdash; a 0‑100 score that rewards
            <em>fast</em> solves on <em>hard</em> puzzles, values <em>recency</em>, and gives a gentle boost for
            tackling lots of puzzles.
          </p>

          <p>
            <strong>1.&nbsp;Per‑puzzle points</strong><br>
            Each time you solve a puzzle you earn
            \(\displaystyle \color{DodgerBlue}{p = w_{rec}\;w_{diff}\;(1+\Delta_{speed})}\).
          </p>

          <ul class="mb-3">
            <li><strong>Recency</strong> \(w_{rec}=2^{-\text{days}/60}\) &nbsp;(60‑day half‑life)</li>
            <li><strong>Difficulty</strong> \(w_{diff}=1+(1-q)^{1.7}\) where \(q=\tfrac{s+1}{a+3}\)</li>
            <li><strong>Speed bonus</strong> \(\Delta_{speed}=\max\bigl(0,\ln\bar t-\ln t_u\bigr)\)</li>
          </ul>

          <p>
            <em>Notation:</em> \(s\) = total solves, \(a\) = attempts on the puzzle, \(\bar t\) = average solve time, \(t_u\) = your time.
          </p>

          <hr class="my-4">

          <p>
            <strong>2.&nbsp;Cumulative strength</strong><br>
            Your lifetime strength grows with the <em>recency‑weighted</em> sums
            \(P=\sum p\) and \(N=\sum w_{rec}\) (volume).
          </p>

          <p>
            <strong>3.&nbsp;Raw rating</strong><br>
            \(R = P\,\bigl(1 + 0.04\,\sqrt{N}\bigr)\)
            &nbsp;&mdash; frequent players get a modest boost.
          </p>

          <p>
            <strong>4.&nbsp;Leaderboard score</strong><br>
            Everyone is placed on a 0‑100 scale:
            \[\displaystyle \text{SPI}=100\,\frac{R}{\max R}\]
            so the current number‑one player always shows <strong>100</strong>.
          </p>

          <hr class="my-4">

          <p><strong>Why exponential decay?</strong></p>
          <p>
            It keeps the board dynamic: a stellar run <em>today</em> can lift you quickly, but you need to keep performing to stay on top.
            After 60&nbsp;days, a solve counts for only half its original value.
          </p>

        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<!-- KaTeX CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">

<!-- KaTeX JS -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "\\[", right: "\\]", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false}
      ]
    });
  });
</script>
{% endblock %}
