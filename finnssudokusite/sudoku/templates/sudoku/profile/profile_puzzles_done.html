{% if attempted_stats %}
{% load formatting star_rating %}
<div class="table-responsive" style="min-height: 400px;">
  <table class="table table-striped table-hover small align-middle" id="doneTable">
    <thead>
    <tr>
      <th style="width: 20%;" onclick="sortDoneTable(0)">Name <span class="sort-indicator"></span></th>
      <th style="width: 10%;" onclick="sortDoneTable(1)">Creator <span class="sort-indicator"></span></th>
      <th style="width: 12%;" onclick="sortDoneTable(2)">Solved / Attempts <span class="sort-indicator"></span></th>
      <th style="width: 15%;" onclick="sortDoneTable(3)">Rating <span class="sort-indicator"></span></th>
      <th style="width: 10%;" onclick="sortDoneTable(4)">Avg Time <span class="sort-indicator"></span></th>
      <th style="width: 10%;" onclick="sortDoneTable(5)">Your Time <span class="sort-indicator"></span></th>
      <th style="width: 13%;" onclick="sortDoneTable(6)">Last Solved <span class="sort-indicator"></span></th>
      <th style="width: 20%;">
        <div class="dropdown">
          <span role="button" class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Tags
          </span>
          <ul class="dropdown-menu p-2" id="doneTagFilterMenu" style="max-height: 200px; overflow-y: auto;">
            {% for tag in all_tags %}
            <li>
              <div class="form-check">
                <input class="form-check-input done-tag-filter" type="checkbox" value="{{ tag.name }}" id="done-tag-{{ tag.name }}" onchange="filterDoneByTags()">
                <label class="form-check-label" for="done-tag-{{ tag.name }}">{{ tag.name }}</label>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </th>
    </tr>
    </thead>
    <tbody>
    {% for stat in attempted_stats %}
    <tr data-tags="{{ stat.sudoku.tags.all|join:',' }}"
        data-name="{{ stat.sudoku.title|lower }}"
        data-creator="{{ stat.sudoku.created_by.username|default_if_none:"" }}"
    data-solves="{{ stat.sudoku.solves }}"
    data-attempts="{{ stat.sudoku.attempts }}"
    data-rating="{{ stat.sudoku.average_rating|default:0 }}"
    data-avgtime="{{ stat.sudoku.average_time|floatformat:0 }}"
    data-besttime="{{ stat.best_time }}"
    data-datesolved="{{ stat.date_solved|date:"U" }}">
    <td>{{ stat.sudoku.title }}</td>
    <td>
      {% if stat.sudoku.created_by %}
      {% if stat.sudoku.created_by.username == request.user.username %}
      <a href="{% url 'profile' %}">{{ stat.sudoku.created_by.username }}</a>
      {% else %}
      <a href="{% url 'user_profile' stat.sudoku.created_by.username %}">{{ stat.sudoku.created_by.username }}</a>
      {% endif %}
      {% else %}
      —
      {% endif %}
    </td>

    <td>{{ stat.sudoku.solves }} / {{ stat.sudoku.attempts }}</td>
    <td>{% render_starbar stat.sudoku.average_rating %}</td>
    <td>{{ stat.sudoku.average_time|humantime }}</td>
    <td>{{ stat.best_time|humantime }}</td>
    <td>{{ stat.date_solved|date:"Y-m-d H:i" }}</td>
    <td>
      {% for tag in stat.sudoku.tags.all %}
      <span class="badge me-1 mb-1 p-1 badge-{{ tag.name }}">{{ tag.name }}</span>
      {% endfor %}
    </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p>You haven’t attempted any puzzles yet.</p>
{% endif %}

<script>
  let currentDoneSortCol = null;
  let doneAscending = true;

  function sortDoneTable(colIndex) {
    const table = document.getElementById("doneTable");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    if (currentDoneSortCol === colIndex) {
      doneAscending = !doneAscending;
    } else {
      doneAscending = true;
      currentDoneSortCol = colIndex;
    }

    rows.sort((a, b) => {
      let valA, valB;

      switch (colIndex) {
        case 0: valA = a.dataset.name; valB = b.dataset.name; break;
        case 1: valA = a.dataset.creator; valB = b.dataset.creator; break;
        case 2:
          valA = parseFloat(a.dataset.solves) / Math.max(1, parseFloat(a.dataset.attempts));
          valB = parseFloat(b.dataset.solves) / Math.max(1, parseFloat(b.dataset.attempts));
          break;
        case 3: valA = parseFloat(a.dataset.rating); valB = parseFloat(b.dataset.rating); break;
        case 4: valA = parseFloat(a.dataset.avgtime); valB = parseFloat(b.dataset.avgtime); break;
        case 5: valA = parseFloat(a.dataset.besttime); valB = parseFloat(b.dataset.besttime); break;
        case 6: valA = parseInt(a.dataset.datesolved); valB = parseInt(b.dataset.datesolved); break;
      }

      if (typeof valA === 'string') {
        return doneAscending ? valA.localeCompare(valB) : valB.localeCompare(valA);
      }
      return doneAscending ? valA - valB : valB - valA;
    });

    document.querySelectorAll("#doneTable .sort-indicator").forEach(el => el.innerHTML = "");
    const arrow = doneAscending ? "▲" : "▼";
    table.querySelector(`thead tr th:nth-child(${colIndex + 1}) .sort-indicator`).innerText = arrow;

    rows.forEach(row => tbody.appendChild(row));
  }

  function filterDoneByTags() {
    const activeTags = Array.from(document.querySelectorAll(".done-tag-filter:checked")).map(el => el.value.toLowerCase());
    const rows = document.querySelectorAll("#doneTable tbody tr");

    rows.forEach(row => {
      const rowTags = row.getAttribute("data-tags").toLowerCase();
      const shouldShow = activeTags.every(tag => rowTags.includes(tag));
      row.style.display = (activeTags.length === 0 || shouldShow) ? "" : "none";
    });
  }
</script>
