{% extends "sudoku/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}Sudoku Creator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sudoku/css/board.css' %}">
<link rel="stylesheet" href="{% static 'sudoku/css/rulemanager.css' %}">
<link rel="stylesheet" href="{% static 'sudoku/css/accordion.css' %}">

<style>
	/* Tabs oben sollen nicht scrollen */
	#nav-tab {
		flex-shrink: 0;
	}
	
	/* Inhalt bekommt volle Höhe */
	#nav-tabContent {
		flex: 1 1 auto;
		display: flex;
		flex-direction: column;
		min-height: 0;
	}
	
	#ruleDropdown {
		max-height: 300px;
		overflow-y: auto;
	}
</style>
{% endblock %}

{% block content %}
<div id="layoutWrapper" class="layout-wrapper">
	<div id="leftCol" class="left-col">
		<div class="my_board_box">
			<div class="board-container">
			</div>
		</div>
	</div>
	<div id="rightCol" class="right-col">
		<nav>
			<div class="nav nav-tabs nav-justified" id="nav-tab" role="tablist">
				<button class="nav-link active" id="nav-Create-tab" data-bs-toggle="tab" data-bs-target="#nav-Create" type="button" role="tab" aria-controls="nav-Create" aria-selected="true">{% trans "Create" %}</button>
				<button class="nav-link" id="nav-Analyse-tab" data-bs-toggle="tab" data-bs-target="#nav-Analyse" type="button" role="tab" aria-controls="nav-Analyse" aria-selected="false">{% trans "Analysis" %}</button>
				<button class="nav-link" id="nav-Publish-tab" data-bs-toggle="tab" data-bs-target="#nav-Publish" type="button" role="tab" aria-controls="nav-Publish" aria-selected="false">{% trans "Publish" %}</button>
			</div>
		</nav>
		<div id="nav-tabContent" class="tab-content my_white_box border-top-0 p-3">
			
			<!--	CREATOR	-->
			<div id="nav-Create" class="tab-pane fade show active" role="tabpanel" aria-labelledby="nav-Create-tab" tabindex="0">
				<h2 class="text-center mt-4">{% trans "Create Your Sudoku" %}</h2>
				
				<div class="position-relative">
					<input type="text" id="ruleSearchInput" class="form-control" placeholder="Start typing..." autocomplete="off">
					<ul id="ruleDropdown" class="list-group position-absolute rounded overflow-auto w-100" style="z-index: 1000;"></ul>
				</div>
				
				<div class="mt-4 flex-fill overflow-auto">
					<div id="accordionContainer" class="accordion w-100 flex-fill"></div>
				</div>
			</div>
			
			<!--	ANALYSE	-->
			<div id="nav-Analyse" class="tab-pane fade" role="tabpanel" aria-labelledby="nav-Analyse-tab" tabindex="0">
				<button id="start-analysis-btn" class="btn btn-primary text-nowrap">{% trans "Start analysis" %}</button>
				<!-- ALERT BOX -->
				<div id="alertBox" class="mt-3"></div>
			</div>
			
			<!--	PUBLISH	-->
			<div id="nav-Publish" class="tab-pane fade" role="tabpanel" aria-labelledby="nav-Publish-tab" tabindex="0">
				<div id="publish-info"></div>
				<form>
					<input type="text" class="form-control mb-3" name="sudoku_name" placeholder="Enter Sudoku name...">
					<button id="submit-sudoku-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSave">Save</button>
				</form>
				<button id="test-sudoku-btn" class="btn btn-primary">Test</button>
			</div>
		
		</div>
	</div>
</div>

{% endblock %}

{% block extra_scripts %}
<script type="module" src="{% static 'sudoku/js/creator/creator_ui.js' %}"></script>

<!--	ALERT SCRIPT	-->
<script>
	document.addEventListener('DOMContentLoaded', function () {
		
		
		const alertBox = document.getElementById('alertBox');
		let result = 12;
		
		// Tab-Wechsel: AlertBox leeren, wenn Analyse-Tab aktiviert wird
		const navAnalyseTab = document.getElementById('nav-Analyse-tab');
		if (navAnalyseTab) {
			navAnalyseTab.addEventListener('shown.bs.tab', () => {
				if (alertBox) {
					alertBox.innerHTML = '';
				}
			});
		}
		
		const openAlert = () => {
			// Alert-HTML neu aufbauen
			alertBox.innerHTML = `
			<div class="alert show" role="alert">
				<p>Analysis is running...</p>
				<div class="progress mb-3" style="height: 28px;">
					<div id="loading-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%;">0%</div>
				</div>
				<div id="alertContent"></div>
			</div>
		`;
			
			
			// Ladebalken-Animation starten
			const progressBar = document.getElementById('loading-bar');
			let progress = 0;
			const interval = setInterval(() => {
				if (progress >= 100) {
					clearInterval(interval);
					progressBar.textContent = 'Complete';
					progressBar.classList.remove('bg-danger');
					progressBar.classList.add('bg-success');
					
					addTextToContent(`<p>${result} solutions were found.</p>`);
					//	addTextToContent(`<p>${result} ${gettext("solutions were found.")}</p>`);
					
					const maxResult = 10;
					const loopLimit = Math.min(result, maxResult);
					let listHTML = "<ol>";
					for (let i = 1; i <= loopLimit; i++) {
						listHTML += "<li><a href='#'>LINK</a></li>";
					}
					listHTML += "</ol>";
					addTextToContent(listHTML);
					
				} else {
					progress += 1;
					progressBar.style.width = progress + '%';
					progressBar.textContent = progress + '%';
				}
			}, 50);
		};
		
		const addTextToContent = (html) => {
			const alertContent = document.getElementById('alertContent');
			if (alertContent) {
				const div = document.createElement('div');
				div.innerHTML = html;
				alertContent.appendChild(div);
			}
		};
		
		// Publish
		if (result > 1) {
			document.getElementById('publish-info').innerHTML = `<p>The Sudoku will only be saved. To publish it, a successful analysis must be completed first.</p>`;
		} else {
			document.getElementById('publish-info').innerHTML = '';
		}
		
		
		// Button-Trigger
		const alertTrigger = document.getElementById('start-analysis-btn');
		if (alertTrigger) {
			alertTrigger.addEventListener('click', openAlert);
		}
		
	});
</script>

<!--	WINDOW RESIZE -->
<script>
	/*  IMPORTANT

	YOU NEED  style.css

	Use this Structure:

	<div id="layoutWrapper" class="layout-wrapper">
		<div id="leftCol" class="left-col"></div>
		<div id="rightCol" class="right-col"></div>
	</div>

 */
	
	function resizeLayout() {
		const wrapper = document.getElementById("layoutWrapper");
		const left = document.getElementById("leftCol");
		
		const isPortrait = window.innerHeight > window.innerWidth;
		wrapper.classList.toggle("portrait", isPortrait);
		wrapper.classList.toggle("landscape", !isPortrait);
		
		const right = document.getElementById("rightCol");
		right.classList.toggle("landscape", !isPortrait);
		right.classList.toggle("portrait", isPortrait);
		
		const rect = wrapper.getBoundingClientRect();
		let size;
		
		if (isPortrait) {
			// Portrait: Quadratische Breite + Höhe, begrenzt durch Wrapper
			const maxHeight = rect.height * 2 / 3;
			const maxWidth = rect.width;
			size = Math.min(maxHeight, maxWidth);
			
			left.style.width = size + "px";
			left.style.height = size + "px";
			
			// Rechte Spalte nimmt restliche Höhe ein
			document.getElementById("rightCol").style.width = size + "px";
			document.getElementById("rightCol").style.height = (rect.height - size) + "px";
		} else {
			const maxHeight = rect.height;
			const maxLeftWidth = rect.width * 2 / 3;
			const leftSize = Math.min(maxHeight, maxLeftWidth);
			
			const availableRight = rect.width - leftSize - 16; // 16px ≈ 1rem margin
			
			const rightWidth = Math.min(availableRight, 450);
			
			left.style.width = leftSize + "px";
			left.style.height = leftSize + "px";
			
			right.style.height = leftSize + "px";
			right.style.width = rightWidth + "px";
			
			// Center beide, wenn genug Platz für beide plus Abstand
			if (availableRight > 450) {
				wrapper.classList.add("centered");
			} else {
				wrapper.classList.remove("centered");
			}
		}
	}
	
	window.addEventListener("resize", resizeLayout);
	window.addEventListener("load", resizeLayout);
	document.addEventListener("DOMContentLoaded", () => setTimeout(resizeLayout, 10));
	document.addEventListener("orientationchange", resizeLayout);

</script>

{% endblock %}