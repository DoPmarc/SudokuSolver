{% extends "sudoku/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}Sudoku Creator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sudoku/css/board.css' %}">
<link rel="stylesheet" href="{% static 'sudoku/css/rulemanager.css' %}">
<link rel="stylesheet" href="{% static 'sudoku/css/accordion.css' %}">
{% endblock %}

{% block content %}
<div id="layoutWrapper" class="layout-wrapper">
	<div id="leftCol" class="left-col">
		<div class="my_board_box">
			<div class="board-container">
			</div>
		</div>
	</div>
	<div id="rightCol" class="right-col">
		<h2 class="text-center mt-4">{% trans "Create Your Sudoku" %}</h2>
		
		<div class="position-relative">
			<input type="text" id="ruleSearchInput" class="form-control" placeholder="Start typing..." autocomplete="off">
			<ul id="ruleDropdown" class="list-group position-absolute rounded overflow-auto w-100" style="z-index: 1000;"></ul>
		</div>
		
		<div class="mt-4 my_white_box flex-fill overflow-auto" style="max-height: 600px;">
			<div id="accordionContainer" class="accordion w-100 flex-fill"></div>
		</div>
		
		
		<!-- Wenn Analyse erfolgreich -->
		<!--<div class="d-flex align-items-start mt-3">
			<div class="d-flex flex-column me-3 gap-3">
				<button id="publishButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPublish">{% trans "Publish" %}</button>
				<button id="analysisButton" class="btn btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#modalAnalysis">{% trans "Start analysis" %}</button>
			</div>
			<div>
				{% blocktrans %}The Sudoku will publish it.{% endblocktrans %}
			</div>
		</div>-->
		
		<!-- Wenn Analyse NICHT erfolgreich -->
		<div class="d-flex align-items-start mt-3">
			<div class="d-flex flex-column me-3 gap-3">
				<button id="submit-sudoku-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSave">{% trans "Save" %}</button>
				<button id="start-analysis-btn" class="btn btn-primary text-nowrap">{% trans "Start analysis" %}</button>
			</div>
			<div>
				{% blocktrans %}The Sudoku will only be saved. To publish it, a successful analysis must be completed first.{% endblocktrans %}
			</div>
		</div>
		<!-- ALERT BOX -->
		<div id="alertBox" class="mt-3"></div>
	</div>
</div>
{% include "sudoku/creator/modal_analyse.html" %}

{% endblock %}

{% block extra_scripts %}
<script type="module" src="{% static 'sudoku/js/creator/creator_ui.js' %}"></script>
<!--	ALERT SCRIPT	-->
<script>
	const alertBox = document.getElementById('alertBox');
	
	const openAlert = () => {
		// Alert-HTML neu aufbauen
		alertBox.innerHTML = `
			<div class="alert alert-light alert-dismissible show" role="alert">
				<p>Analysis is running...</p>
				<button type="button" class="btn-close" aria-label="Close" id="alertCloseBtn"></button>
				<div class="progress mb-3" style="height: 28px;">
					<div id="loading-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%;">0%</div>
				</div>
				<div id="alertContent"></div>
			</div>
		`;
		
		// Event-Listener für manuelles Schließen
		document.getElementById('alertCloseBtn').addEventListener('click', () => {
			alertBox.innerHTML = ''; // komplett entfernen
		});
		
		// Ladebalken-Animation starten
		const progressBar = document.getElementById('loading-bar');
		let progress = 0;
		const interval = setInterval(() => {
			if (progress >= 100) {
				clearInterval(interval);
				progressBar.textContent = 'Complete';
				progressBar.classList.remove('bg-danger');
				progressBar.classList.add('bg-primary');
				addTextToContent("<p>Es wurde X Lösungen gefunden</p>")
			} else {
				progress += 1;
				progressBar.style.width = progress + '%';
				progressBar.textContent = progress + '%';
			}
		}, 50);
	};
	
	const addTextToContent = (html) => {
		const alertContent = document.getElementById('alertContent');
		if (alertContent) {
			const div = document.createElement('div');
			div.innerHTML = html; // ← HTML wird korrekt interpretiert
			alertContent.appendChild(div);
		}
	};
	
	// Button-Trigger
	const alertTrigger = document.getElementById('start-analysis-btn');
	if (alertTrigger) {
		alertTrigger.addEventListener('click', openAlert);
	}
	
</script>

<script>
	/*  IMPORTANT

	YOU NEED  style.css

	Use this Structure:

	<div id="layoutWrapper" class="layout-wrapper">
		<div id="leftCol" class="left-col"></div>
		<div id="rightCol" class="right-col"></div>
	</div>

 */
	
	function resizeLayout() {
		const wrapper = document.getElementById("layoutWrapper");
		const left = document.getElementById("leftCol");
		
		const isPortrait = window.innerHeight > window.innerWidth;
		wrapper.classList.toggle("portrait", isPortrait);
		wrapper.classList.toggle("landscape", !isPortrait);
		
		const right = document.getElementById("rightCol");
		right.classList.toggle("landscape", !isPortrait);
		right.classList.toggle("portrait", isPortrait);
		
		const rect = wrapper.getBoundingClientRect();
		let size;
		
		if (isPortrait) {
			// Portrait: Quadratische Breite + Höhe, begrenzt durch Wrapper
			const maxHeight = rect.height * 2 / 3;
			const maxWidth = rect.width;
			size = Math.min(maxHeight, maxWidth);
			
			left.style.width = size + "px";
			left.style.height = size + "px";
			
			// Rechte Spalte nimmt restliche Höhe ein
			document.getElementById("rightCol").style.width = size + "px";
			document.getElementById("rightCol").style.height = (rect.height - size) + "px";
		} else {
			const maxHeight = rect.height;
			const maxLeftWidth = rect.width * 2 / 3;
			const leftSize = Math.min(maxHeight, maxLeftWidth);
			
			const availableRight = rect.width - leftSize - 16; // 16px ≈ 1rem margin
			
			const rightWidth = Math.min(availableRight, 450);
			
			left.style.width = leftSize + "px";
			left.style.height = leftSize + "px";
			
			right.style.height = leftSize + "px";
			right.style.width = rightWidth + "px";
			
			// Center beide, wenn genug Platz für beide plus Abstand
			if (availableRight > 450) {
				wrapper.classList.add("centered");
			} else {
				wrapper.classList.remove("centered");
			}
		}
	}
	
	window.addEventListener("resize", resizeLayout);
	window.addEventListener("load", resizeLayout);
	document.addEventListener("DOMContentLoaded", () => setTimeout(resizeLayout, 10));
	document.addEventListener("orientationchange", resizeLayout);

</script>

{% endblock %}